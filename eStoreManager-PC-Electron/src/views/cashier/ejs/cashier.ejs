<%- include('../../shared/ejs/header', {title: 'Cashier'}) %>
<link rel="stylesheet" type="text/css" href="../css/cashier.css">
<link rel="stylesheet" href="../../../../node_modules/datatables.net-dt/css/jquery.dataTables.min.css">

<%- include('../../shared/ejs/secondary_menu.ejs') %>

<div class="container-fluid main-container">
	<div class="row" style="padding-top: 1rem;">
		<div class="col-sm-1">
			<img style="width: 85px; border: 1px solid #333" src="../images/barcode-scanner.jpg" alt="barcode">
		</div>
		<div class="col-sm-5">
			<div class="input-group pt-3">
				<div class="input-group-prepend">
					<span class="input-group-text"><%= gettext.product_id_or_barcode %></span>
				</div>
				<input type="text" class="form-control" placeholder="Eg. 2234">
				<div class="input-group-append">
					<button class="btn btn-warning" type="button"><%= gettext.add_product %></button>
				</div>
			</div>
		</div>
		<div class="col-sm-5">
			<div class="input-group pt-3">
				<div class="input-group-prepend">
					<span class="input-group-text"><%= gettext.product_name %></span>
				</div>
				<input id="search_form_product" type="text" placeholder="E.g: Milk" class="form-control">
				<div class="input-group-append">
					<button class="btn btn-success" type="button"><%= gettext.search %></button>
				</div>
			</div>
		</div>
	</div>
	<div class="row" style="min-height: 350px">
		<div class="col-sm-8 mt-2">
			<table id="product-table" class="display" width="100%"></table>
		</div>
		<div id="cashier-total-area" class="col-sm-4">
			<table>
				<tr>
					<td>
						<label class="total-title"><%= gettext.sub_total %></label>
					</td>
					<td>
						<input readonly class="total-number" type="text" class="form-control">
					</td>
				</tr>
				<tr>
					<td>
						<label class="total-title"><%= gettext.tax %></label>
					</td>
					<td>
						<input readonly class="total-number" type="text" class="form-control">
					</td>
				</tr>
				<tr>
					<td>
						<label class="total-title"><%= gettext.grand_total %></label>
					</td>
					<td>
						<input readonly class="total-number" type="text" class="form-control">
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div style="padding: 2rem"></div>
					</td>
				</tr>
				<tr>
					<td>
						<label class="total-title title-sm"><%= gettext.customer_pay %></label>
					</td>
					<td>
						<input class="total-number" type="text" class="form-control">
					</td>
				</tr>
				<tr>
					<td>
						<label class="total-title title-sm"><%= gettext.give_back_to_customer %></label>
					</td>
					<td>
						<input readonly class="total-number" type="text" class="form-control">
					</td>
				</tr>
			</table>
		</div>
	</div>
</div>

<div class="container-fluid" style="position:fixed; bottom: 0; left: 0;">
	<div class="row" style="padding: 1rem; background: ghostwhite">
		<div class="col-sm-2">
			<p><b><%= gettext.employee %>:</b> <span id="logged-in-user"></span></p>
			<p><b><%= gettext.time %>:</b> <span id="clock"></span></p>
		</div>
		<div class="col-sm-4">
			<p><b><%= gettext.customer %>:</b> <span id="customer-name">SyAn</span></p>
			<div class="input-group">
			<input type="text" class="form-control" placeholder="CustomerID" aria-label="CustomerID" aria-describedby="basic-addon2">
				<div class="input-group-append">
					<button class="btn btn-primary" type="button"><%= gettext.search %></button>
					<button class="btn btn-success" type="button"><%= gettext.new %></button>
				</div>
			</div>
		</div>
		<div class="col-sm-6">
			<button class="btn btn-lg btn-warning btn-super-lg"><%= gettext.print_receipt %></button>
			<button class="btn btn-lg btn-success btn-super-lg"><%= gettext.complete_f9 %></button>
			<button class="btn btn-lg btn-danger btn-super-lg"><%= gettext.discard %></button>
		</div>
	</div>
</div>

<!-- Load autocomplete - https://github.com/devbridge/jQuery-Autocomplete -->
<script src="../../shared/js/jquery.autocomplete.min.js"></script>

<script>
	$(document).ready(() => {

		// Load library
		const settings = require('electron-settings');
		const EventGetter = require("../../../services/EventGetter").EventGetter;
		const TextGetter = require("../../../services/TextGetter").TextGetter;
		const {ipcRenderer} = require('electron');
		var dt = require( 'datatables.net-dt' )( window, $ );
		require( 'datatables.net-responsive-dt' )( window, $ );

		const ProductTypeController = require("../../../controllers/ProductTypeController.js").ProductTypeController;
		let productTypeControllerController = new ProductTypeController();

		const UserController = require("../../../controllers/UserController.js").UserController;
		let userController = new UserController();
		
		// === Create product table ===
		dataTable = $('#product-table').DataTable({
			searching: false,
			columns: [
				{ 
					title: TextGetter.get("product_id"),
					data: "id"
				},
				{ 
					title: TextGetter.get("product_name"),
					data: "name"
				},
				{ 
					title: TextGetter.get("price"),
					data: "price"
				},
				{ 
					title: TextGetter.get("quantity"),
					data: "quantities"
				},
				{ 
					title: TextGetter.get("quantity_manipulation"),
					data: null
				},
				{ 
					title: TextGetter.get("unit"),
					data: "unit"
				},
				{ 
					title: TextGetter.get("total"),
					data: "total"
				},
				{ 
					title: TextGetter.get("delete_question")
				}
			],
			"columnDefs": [ {
				"targets": -1,
				"data": null,
				"defaultContent": `
					<button type="button" class="delete-product btn btn-sm btn-danger">
						<i class="fa fa-trash-o" aria-hidden="true"></i>
					</button>
					`
			},
			{
				"targets": -2,
				"data": null,
				render: function(data,type,row) { return (Number(row["price"]) * Number(row["quantities"]))}
			},
			{
				"targets": 4,
				"data": null,
				"defaultContent": `
					<button type="button" class="edit-quantity btn btn-sm btn-default">
						<i class="fa fa-pencil-square-o" aria-hidden="true"></i>
					</button>
					<button type="button" class="increase-quantity btn btn-sm btn-success">
						<i class="fa fa-plus" aria-hidden="true"></i>
					</button>
					<button type="button" class="decrease-quantity btn btn-sm btn-warning">
						<i class="fa fa-minus" aria-hidden="true"></i>
					</button>
					`
			}
			],
			"responsive": true,
			"pageLength": 5,
			"lengthMenu": [[5, 8, 10, -1], [5, 8, 10, "All"]]
		});
		
		// === Function to add product to table ===
		function addProduct(productId) {

			// Get product information
			let productData = productTypeControllerController.getProductTypeData(productId,
				(response) => { // Success
					response.quantities = 1;
					response.total = 0;
					dataTable.row.add(response).draw(false);
				},
				(response) => { //Fail
					alert(TextGetter.get("cannot_get_product_by_id") + productId);
				}
			);

		}

		// === Setup Clock ====
		function startTimer() {
    		var today = new Date();
			var h = today.getHours();
			var m = today.getMinutes();
			var s = today.getSeconds();
			var day = today.getDate();
			var month = today.getMonth() + 1;
			m = checkTime(m);
			s = checkTime(s);
			$("#clock").html(h + ":" + m + ":" + s + "&nbsp;&nbsp;" + day + "/" + month);
			var t = setTimeout(startTimer, 500);
		}
		function checkTime(i) {
			if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
			return i;
		}
		startTimer();

		// === Show Employee ID ===
		$("#logged-in-user").html(userController.getLoggedInUserDisplayName());

		// === Ajax Search for product ===
		// Autocomplete searching for products
		$('#search_form_product').autocomplete({
			lookup: function (query, done) {
				
				let headers = Object({'Content-Type': 'application/json'});
				headers['Authorization'] = "Bearer " + settings.get('account_info.token');

				let postData = {};
				postData.draw = 1;
				postData.length = 8;
				postData.search = {};
				postData.search.value = query;
				postData.start = 0;
				postData = JSON.stringify(postData);

				$.ajax({
					"url": productTypeControllerController.getAjaxAPIUrl(),
                    "type": 'POST',
                    "headers": headers,
                    "processData": true,
                    "contentType": 'application/json',
                    "data": postData
				})
				.done(function( respond ) {
					let result = {
						suggestions: []
					};
					let data = respond.data;
					for (let i = 0 ; i < data.length; ++i) {
						let value = data[i].name + " : " + data[i].barcode;
						result.suggestions.push({"value": value
							, "data": data[i]});
					}
					done(result);
				});
				
			},
			onSelect: function (suggestion) {
				// alert('You selected: ' + suggestion.value + ', ' + suggestion.data);
				$("#search_form_product").val(""); // Prevent searching loop
				addProduct(suggestion.data.id);
			}
		});

	});

</script>

<%- include('../../shared/ejs/footer') %>
